#pragma once
#include <string>
#include <memory>
#include <vector>
#include <opencv2/core.hpp>

struct _GstElement;
using GstElement = _GstElement;

namespace ss {
    struct FramePacket {
        cv::Mat bgr;
        int64_t pts_ns = 0;
        int64_t frame_id = 0;
    };

    struct DualFramePacket {
        cv::Mat inf_frame;
        cv::Mat ui_frame;

        int64_t pts_ns = 0;
        int64_t frame_id = 0;

        float scale_x = 0.0f;
        float scale_y = 0.0f;
    };

    class GstDualSource {
    public:
        GstDualSource(std::string pipeline,
                      std::string id,
                      std::string sink_inf_name,
                      std::string sink_ui_name);

        bool start();
        void stop();

        bool read(DualFramePacket& out, int timeout_ms);

        const std::string& id() const { return id_; };

        ~GstDualSource();
    private:
        bool pull_bgr_(GstElement* sink, FramePacket& out, int timeout_ms);

        std::string pipeline_str_;
        std::string id_;
        std::string sink_inf_name_;
        std::string sink_ui_name_;

        GstElement* pipeline_ = nullptr;
        GstElement* sink_inf_ = nullptr;
        GstElement* sink_ui_ = nullptr;

        int64_t inf_frame_id_ = 0;
        int64_t ui_frame_id_ = 0;

        float scale_x_ = 1.0f;
        float scale_y_ = 1.0f;
    };
}